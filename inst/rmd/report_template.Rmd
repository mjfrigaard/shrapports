---
title: "Data Analysis Report"
author: "Generated by shrapports"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
params:
  dataset_name: "penguins"
  current_data: NULL
  x_variable: "bill_length_mm"
  y_variable: "bill_depth_mm"
  color_variable: NULL
  summary_data: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE,
  message = FALSE)
library(ggplot2)
library(gt)
library(knitr)
library(dplyr)
```

# Executive Summary

This report provides an analysis of the `r params$dataset_name` dataset, exploring the relationship between `r params$y_variable` and `r params$x_variable`. 

The report was generated on `r format(Sys.time(), '%B %d, %Y at %H:%M:%S')`.

## Dataset Overview

```{r}
# Summary of the dataset in a nicely formatted table
overview_data <- data.frame(
  Metric = c("Dataset", "Number of observations", "Number of variables"),
  Value = c(params$dataset_name, nrow(params$current_data), ncol(params$current_data))
)

gt::gt(overview_data) |>
  gt::tab_header(title = "Dataset Overview") |>
  gt::cols_align(align = "left", columns = everything())
```

## Structure of the Data

```{r}
# Display the structure of the variables being analyzed
vars_of_interest <- c(params$x_variable, params$y_variable)
if (!is.null(params$color_variable)) {
  vars_of_interest <- c(vars_of_interest, params$color_variable)
}

# Create a data frame to display structure info
vars_subset <- params$current_data[, vars_of_interest, drop = FALSE]
structure_info <- lapply(vars_subset, function(x) {
  data.frame(
    Type = class(x)[1],
    Missing = sum(is.na(x)),
    Unique_Values = length(unique(x))
  )
})

structure_df <- do.call(rbind, structure_info)
structure_df$Variable <- rownames(structure_df)
rownames(structure_df) <- NULL
structure_df <- structure_df[, c("Variable", "Type", "Missing", "Unique_Values")]

gt::gt(structure_df) |>
  gt::tab_header(title = "Variable Information") |>
  gt::cols_align(align = "left", columns = "Variable") |>
  gt::cols_align(align = "right", columns = c("Missing", "Unique_Values"))
```

# Data Visualization

```{r fig.width=8, fig.height=5}
# Create the scatter plot
plot <- ggplot2::ggplot(params$current_data, 
               ggplot2::aes_string(
                 x = params$x_variable, 
                 y = params$y_variable))

# Add color if available
if (!is.null(params$color_variable)) {
  plot <- plot +
    ggplot2::geom_point(
      ggplot2::aes_string(
        color = params$color_variable), 
      alpha = 0.7, size = 3) +
    ggplot2::labs(
      color = stringr::str_to_title(params$color_variable))
} else {
  plot <- plot + ggplot2::geom_point(alpha = 0.7, size = 3)
}

# Complete the plot
plot +
  ggplot2::theme_minimal() +
  ggplot2::labs(
    title = paste(params$y_variable, "vs", params$x_variable),
    x = params$x_variable,
    y = params$y_variable
  )
```

# Statistical Summary

```{r}
# Display the correlation statistics
if (!is.null(params$summary_data)) {
  gt::gt(params$summary_data) |>
    gt::tab_header(
      title = paste("Correlation Analysis:", 
        params$y_variable, "vs", 
        params$x_variable)) |>
    gt::fmt_number(
      columns = c("Mean_X", "SD_X", "Mean_Y", "SD_Y", "Correlation"), decimals = 3) |>
    gt::cols_label(
      Group = if (!is.null(params$color_variable)) stringr::str_to_title(params$color_variable) else "Group",
      Mean_X = paste("Mean", params$x_variable),
      SD_X = paste("SD", params$x_variable),
      Mean_Y = paste("Mean", params$y_variable),
      SD_Y = paste("SD", params$y_variable),
      Correlation = "Correlation (r)"
    ) |>
    gt::tab_footnote(
      footnote = "Pearson correlation coefficient ranges from -1 to 1",
      locations = gt::cells_column_labels(columns = "Correlation")
    )
} else {
  cat("No statistical summary available.")
}
```

# Conclusions

This report has explored the relationship between `r params$y_variable` and `r params$x_variable` in the `r params$dataset_name` dataset. 

```{r, results='asis'}
# Get overall correlation
x_data <- params$current_data[[params$x_variable]]
y_data <- params$current_data[[params$y_variable]]
overall_cor <- cor(x_data, y_data, use = "pairwise.complete.obs")

if (abs(overall_cor) < 0.3) {
  cat("The analysis reveals a weak correlation between these variables (r =", round(overall_cor, 3), ").")
} else if (abs(overall_cor) < 0.7) {
  cat("The analysis reveals a moderate correlation between these variables (r =", round(overall_cor, 3), ").")
} else {
  cat("The analysis reveals a strong correlation between these variables (r =", round(overall_cor, 3), ").")
}
```

```{r, results='asis'}
if (!is.null(params$color_variable)) {
  cat("\n\nThe visualization also highlights differences in this relationship across different", params$color_variable, "groups.")
}
```

This report was generated automatically by the shrapports package. For more detailed analysis, you may want to conduct additional statistical tests or explore other variables in the dataset.
